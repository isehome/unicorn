# UniFi Client Endpoint Solution

## Executive Summary

**CRITICAL FINDING**: The Network API v1 clients endpoint **cannot be accessed through `api.ui.com` cloud proxy**. The Network API runs locally on each controller and requires either:
1. **Direct local access** to the controller at its LAN/WAN IP address, OR
2. **The legacy API** accessed through `/proxy/network/api/s/{site}/stat/sta` path

The Site Manager API at `api.ui.com` provides high-level access to hosts and devices but **does not expose client data**.

---

## Research Findings

### Two Separate UniFi APIs

There are **two distinct APIs** with different purposes and access patterns:

#### 1. Site Manager API (Cloud API) ✅ Working
- **Base URL**: `https://api.ui.com`
- **Purpose**: High-level site management across all your UniFi deployments
- **Access**: Cloud-hosted, accessible from anywhere
- **Authentication**: Cloud API key (X-API-KEY header)
- **Available Endpoints**:
  - `/v1/hosts` - List all UniFi controllers/consoles
  - `/v1/devices` - List all network devices
  - `/v1/alarms` - System alarms
  - `/v1/events` - Historical events
- **Does NOT provide**: Client data, detailed network statistics, port-level information

#### 2. Network Application API (Local API) ❌ Not Cloud Accessible
- **Base URL**: `https://{controller-ip}/` (local) or `https://{controller-ip}/proxy/network/` (UniFi OS)
- **Purpose**: Detailed network management for a specific controller
- **Access**: Must be on local network OR have direct access to controller IP
- **Authentication**: Network API key (X-API-KEY header) OR username/password session
- **Available Endpoints**:
  - `/api/s/{site}/stat/sta` - Active clients (legacy format)
  - `/api/s/{site}/stat/user` - All configured clients
  - `/integration/v1/clients` - Clients (new v1 format)
  - `/integration/v1/sites/{siteId}/clients` - Site-specific clients
  - Device port tables, VLANs, detailed statistics, etc.
- **Cloud Access**: NOT available through api.ui.com proxy

### Why Your Tests Return 404

All these endpoints return 404 because they don't exist on `api.ui.com`:

```
❌ https://api.ui.com/v1/clients
❌ https://api.ui.com/v1/sites/1380092638/clients
❌ https://api.ui.com/proxy/network/integration/v1/clients
❌ https://api.ui.com/v1/consoles/{consoleId}/proxy/network/integration/v1/clients
```

**Why?** The Site Manager API at `api.ui.com` is a **separate cloud service** that aggregates data from controllers, but it doesn't proxy Network API requests. The `/proxy/network/` path only works when connecting **directly to a controller**, not through the cloud API.

### The Documentation Clue

The URL you shared reveals the truth:
```
https://unifi.ui.com/consoles/6C63F82BC2D10000000008E7C92D00000000096176EB0000000067E300F0:1380092638/unifi-api/network
```

This is the **web UI documentation viewer** at `unifi.ui.com` (not `api.ui.com`), which shows the Swagger docs for that specific controller. The documentation itself is generated by the controller and served through the UI - it's not indicating a cloud API endpoint.

---

## Correct Endpoint Formats (By Access Method)

### Option A: Direct Controller Access (Requires Local/VPN Access)

**For UniFi OS Devices (UDM, UDM Pro, UDR, Dream Router, etc.)**

```http
POST https://{wan-ip}/api/auth/login
Content-Type: application/json

{
  "username": "admin",
  "password": "password"
}
```

Then use session cookie for subsequent requests:

```http
GET https://{wan-ip}/proxy/network/api/s/{site}/stat/sta
Cookie: TOKEN={session-cookie}
```

**For Legacy Controllers (Cloud Key, Software Controller)**

```http
POST https://{controller-ip}:8443/api/login
Content-Type: application/json

{
  "username": "admin",
  "password": "password"
}
```

Then:

```http
GET https://{controller-ip}:8443/api/s/{site}/stat/sta
Cookie: unifises={session-cookie}
```

**OR with Network API Key (UniFi OS only)**

```http
GET https://{wan-ip}/proxy/network/integration/v1/clients
X-API-KEY: j_ChcU0fSMHlxPoj8djPhkBYgFVy0LAq
```

### Option B: Legacy API Through Cloud (May Not Exist)

Based on research, there's **no confirmed way** to access the legacy `/api/s/default/stat/sta` endpoint through `api.ui.com`. Some forum posts suggest it was considered but never implemented.

### Option C: Extract Client Data from Device Responses (Partial Solution)

The `/v1/devices` endpoint (which DOES work) may include **partial client information** embedded in switch responses:

```http
GET https://api.ui.com/v1/devices?hostIds[]={consoleId}
X-API-KEY: {cloud-api-key}
```

Response may include:
```json
{
  "data": [
    {
      "model": "USW-24-POE",
      "mac": "aa:bb:cc:dd:ee:ff",
      "port_table": [
        {
          "port_idx": 1,
          "name": "Port 1",
          "up": true,
          "poe_enable": true,
          "poe_mode": "auto",
          "poe_power": "15.4",
          // MAY include client MAC if available
          "port_poe": {
            "poe_mode": "auto",
            "poe_voltage": "54.00"
          }
        }
      ]
    }
  ]
}
```

**Limitations**:
- Not all controllers expose client MACs in device responses
- Only shows actively connected wired clients
- No hostname, IP, or VLAN information
- Inconsistent across controller versions

---

## Authentication Methods

### Cloud API Key (Site Manager API)
```http
X-API-KEY: {your-cloud-api-key}
```
- Generated at: https://unifi.ui.com → API section
- **Scope**: Access to hosts, devices, alarms, events
- **Does NOT grant**: Access to Network API endpoints

### Network API Key (Local Controller)
```http
X-API-KEY: j_ChcU0fSMHlxPoj8djPhkBYgFVy0LAq
```
- Generated at: Network Application → Control Plane → Integrations
- **Scope**: Full access to Network API on that specific controller
- **Requires**: Direct network access to controller
- **Cannot be used** with `api.ui.com`

### Session-Based Authentication (Legacy)
```http
Cookie: unifises={session-cookie}
```
- Obtained by POSTing credentials to `/api/login`
- **Scope**: Full access for the authenticated user
- **Requires**: Direct network access to controller
- **Expires**: After timeout period (usually 24 hours)

---

## Why Direct WAN IP Access Fails from Vercel

Your test showed this fails:
```
https://47.199.106.32/v1/sites/1380092638/clients → Gateway Timeout
```

**Reasons**:
1. **Self-Signed SSL Certificate**: Most UniFi controllers use self-signed certificates, which Vercel/Node.js reject by default
2. **Firewall Rules**: Controller may block external IP ranges (including Vercel's)
3. **No Public API**: Most controllers aren't configured for public internet access
4. **Port Forwarding**: Even if port 443 is forwarded, the controller may require local network context

---

## Alternative Solutions

### Solution 1: Check Embedded Client Data in Devices Response

**Implementation**:
```javascript
// Already working in your code
const devicesResult = await unifiApi.fetchDevices(hostIdsForRequest, url, {
  fetchAll: true,
  pageSize: 200
}, apiKey);

// Search through port_table arrays for potential client info
const devices = devicesResult.data || [];
devices.forEach(device => {
  if (device.port_table) {
    device.port_table.forEach(port => {
      // Check for client identifiers in port data
      console.log('Port', port.port_idx, 'data:', port);
    });
  }
});
```

**Pros**:
- Works with existing cloud API
- No additional authentication needed
- Accessible from Vercel

**Cons**:
- Inconsistent across controller versions
- Limited information (no hostnames, IPs)
- Only wired clients, only if controller populates this data

### Solution 2: Create a Local Proxy Service

Deploy a small service on the same network as the UniFi controller:

**Architecture**:
```
Vercel App → Your Local Proxy (Raspberry Pi, etc.) → UniFi Controller
            ↑ Public HTTPS endpoint           ↑ Local network access
```

**Local Proxy** (Node.js example):
```javascript
// local-unifi-proxy.js
const express = require('express');
const fetch = require('node-fetch');
const https = require('https');

const agent = new https.Agent({ rejectUnauthorized: false });
const app = express();

app.get('/api/clients/:site', async (req, res) => {
  const { site } = req.params;

  // Login to controller
  const loginResponse = await fetch(
    'https://192.168.1.1/api/auth/login',
    {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        username: process.env.UNIFI_USER,
        password: process.env.UNIFI_PASS
      }),
      agent
    }
  );

  const cookies = loginResponse.headers.raw()['set-cookie'];

  // Get clients
  const clientsResponse = await fetch(
    `https://192.168.1.1/proxy/network/api/s/${site}/stat/sta`,
    {
      headers: { 'Cookie': cookies.join('; ') },
      agent
    }
  );

  const data = await clientsResponse.json();
  res.json(data);
});

app.listen(3001);
```

**Pros**:
- Full access to Network API
- All client data available
- Can use Network API key or credentials

**Cons**:
- Requires infrastructure on local network
- More complex deployment
- Must keep proxy service running

### Solution 3: Manual Data Entry

For now, allow users to manually enter client information:

**Implementation**:
```javascript
// In your wire drop commissioning interface
const [manualClient, setManualClient] = useState({
  mac: '',
  hostname: '',
  ip: '',
  switch_mac: '',
  switch_port: '',
  vlan: ''
});

// Provide form fields for manual entry
<div className="manual-client-entry">
  <h3>Manual Client Entry</h3>
  <input
    placeholder="MAC Address"
    value={manualClient.mac}
    onChange={e => setManualClient({...manualClient, mac: e.target.value})}
  />
  <input
    placeholder="Hostname"
    value={manualClient.hostname}
    onChange={e => setManualClient({...manualClient, hostname: e.target.value})}
  />
  {/* ... more fields ... */}
</div>
```

**Pros**:
- Works immediately
- No API dependencies
- User has full control

**Cons**:
- Manual data entry burden
- Prone to errors
- Time-consuming for large deployments

### Solution 4: Hybrid Approach (RECOMMENDED)

Combine automatic and manual methods:

1. **Try to extract** client info from device port_table data (if available)
2. **Prompt user** to manually enter missing information
3. **Save to database** for future reference
4. **Provide option** to upload CSV of client mappings

**Example Flow**:
```javascript
// 1. Try automatic discovery
const discoveredClients = await discoverClientsFromDevices(devices);

// 2. Show what was found
console.log('Auto-discovered:', discoveredClients.length, 'clients');

// 3. Allow manual entry/correction
discoveredClients.forEach(client => {
  if (!client.hostname) {
    // Prompt user to enter hostname
  }
  if (!client.vlan) {
    // Prompt user to select VLAN
  }
});

// 4. Save to Supabase for future use
await saveClientMappings(projectId, discoveredClients);
```

---

## Implementation Changes Needed

### For Local Controller Access (If You Deploy Local Proxy)

Update `/api/unifi-proxy.js`:

```javascript
// Add new parameter to detect Network API requests
const isNetworkApiRequest = endpoint.startsWith('/api/s/') ||
                            endpoint.startsWith('/integration/v1/');

if (isNetworkApiRequest) {
  // Route to local controller instead of api.ui.com
  const localControllerUrl = process.env.LOCAL_CONTROLLER_URL || 'https://192.168.1.1';
  url = `${localControllerUrl}/proxy/network${endpoint}`;

  // Use Network API key
  useNetworkApiKey = true;
}
```

### For Hybrid Manual Entry

Update `/src/components/WireDropsList.js`:

```javascript
// Add manual client entry state
const [manualEntry, setManualEntry] = useState({});

// In commissioning modal
<div className="client-discovery">
  {autoDiscoveredClients.length > 0 ? (
    <div>
      <h4>Discovered Clients</h4>
      {autoDiscoveredClients.map(client => (
        <ClientCard key={client.mac} client={client} />
      ))}
    </div>
  ) : (
    <div className="no-auto-discovery">
      <p>Unable to automatically discover clients.</p>
      <button onClick={() => setShowManualEntry(true)}>
        Enter Client Information Manually
      </button>
    </div>
  )}

  {showManualEntry && (
    <ManualClientEntry
      onSave={(data) => handleManualClientEntry(data)}
      onCancel={() => setShowManualEntry(false)}
    />
  )}
</div>
```

### For Device Port Table Extraction

Update `/src/services/unifiApi.js`:

```javascript
/**
 * Extract potential client information from device port tables
 * @param {Array} devices - Array of device objects from /v1/devices
 * @returns {Array} Array of discovered client connections
 */
export const extractClientsFromDevices = (devices) => {
  const clients = [];

  devices.forEach(device => {
    // Only switches have useful port_table data
    if (!device.port_table || device.type !== 'usw') return;

    device.port_table.forEach(port => {
      // Check if port has active connection
      if (!port.up) return;

      // Try to find client identifier in port data
      const clientMac = port.mac ||
                       port.client_mac ||
                       port.port_poe?.client_mac;

      if (clientMac) {
        clients.push({
          mac: clientMac,
          switch_mac: device.mac,
          switch_name: device.name,
          switch_port: port.port_idx,
          port_name: port.name,
          vlan: port.native_networkconf_id || port.vlan,
          poe_enabled: port.poe_enable,
          poe_mode: port.poe_mode,
          discovered_from: 'device_port_table'
        });
      }
    });
  });

  return clients;
};
```

---

## Example Request/Response (If Local Access Was Possible)

### Request
```http
GET https://47.199.106.32/proxy/network/api/s/default/stat/sta
X-API-KEY: j_ChcU0fSMHlxPoj8djPhkBYgFVy0LAq
Accept: application/json
```

### Response
```json
{
  "meta": {
    "rc": "ok"
  },
  "data": [
    {
      "_id": "5f8a9b8c9d8e7f6a5b4c3d2e",
      "mac": "aa:bb:cc:dd:ee:ff",
      "site_id": "5f8a9b8c9d8e7f6a5b4c3d2f",
      "oui": "Apple",
      "is_wired": true,
      "hostname": "Johns-MacBook-Pro",
      "name": "Johns MacBook Pro",
      "ip": "192.168.1.100",
      "network": "Default",
      "network_id": "5f8a9b8c9d8e7f6a5b4c3d3a",
      "vlan": 1,
      "sw_mac": "11:22:33:44:55:66",
      "sw_port": 8,
      "sw_depth": 1,
      "is_guest": false,
      "first_seen": 1602873676,
      "last_seen": 1634409676,
      "uptime": 86400,
      "is_online": true,
      "rx_bytes": 1234567890,
      "tx_bytes": 9876543210,
      "rx_packets": 12345,
      "tx_packets": 54321
    }
  ]
}
```

This is the data you need, but it's only accessible via local network connection.

---

## References

### Official Documentation
- [Getting Started with Official UniFi API](https://help.ui.com/hc/en-us/articles/30076656117655-Getting-Started-with-the-Official-UniFi-API)
- [Site Manager API Documentation](https://developer.ui.com/site-manager-api/gettingstarted)
- Network API Swagger: Available in your controller at Settings → Control Plane → Integrations

### Community Resources
- [Ubiquiti Community Wiki - UniFi Controller API](https://ubntwiki.com/products/software/unifi-controller/api)
- [Art-of-WiFi UniFi API Client (PHP)](https://github.com/Art-of-WiFi/UniFi-API-client)
- [UniFi Best Practices Guide (GitHub)](https://github.com/uchkunrakhimow/unifi-best-practices)

### Key Findings from Research
- `/proxy/network/` prefix is **only for local controller access**, not cloud API
- `api.ui.com` provides Site Manager API, NOT Network Application API
- Network API v1 with `/integration/v1/` paths runs on controller, not in cloud
- Client data requires either local access OR embedded extraction from devices

---

## Conclusion

**The hard truth**: UniFi's cloud API (`api.ui.com`) does not provide client data. You must either:

1. **Accept limited data** from device responses (if available)
2. **Deploy a local proxy** on the same network as controllers
3. **Implement manual entry** for client information
4. **Wait for Ubiquiti** to add client endpoints to Site Manager API (no timeline)

**Recommended Path Forward**:
1. Start with **hybrid approach**: Try to extract client info from devices, fall back to manual entry
2. Save all client mappings to your Supabase database for reuse
3. Consider **local proxy deployment** if you have many projects requiring automation
4. Monitor Ubiquiti's API roadmap for future cloud client endpoint availability

The Site Manager API is excellent for discovering sites and devices across your deployments, but for detailed client information, you're currently limited to local controller access or manual data collection.

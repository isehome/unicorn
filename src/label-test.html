<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Label Layout Test</title>
    <!-- QRCode Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            padding: 20px;
            background: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            max-width: 900px;
            width: 100%;
        }

        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            gap: 15px;
            align-items: center;
        }

        .nav-controls {
            display: flex;
            gap: 20px;
            align-items: center;
            width: 100%;
            justify-content: center;
        }

        .dimension-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 6px;
            justify-content: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .control-group label {
            font-size: 12px;
            font-weight: bold;
            color: #666;
        }

        .card {
            background: white;
            padding: 40px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .label-preview-container {
            position: relative;
            margin: 20px 0;
            display: inline-block;
        }

        .label-preview {
            border: 1px solid #ccc;
            display: block;
            background: white;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Visual guide for non-printable area */
        .guide-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            border: 1px solid rgba(255, 0, 0, 0.3);
        }

        .guide-line {
            position: absolute;
            left: 0;
            width: 100%;
            border-top: 1px dashed rgba(255, 0, 0, 0.5);
        }

        .guide-label {
            position: absolute;
            right: -80px;
            font-size: 10px;
            color: red;
        }

        button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            font-size: 16px;
        }

        button:hover {
            background: #1d4ed8;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .info {
            text-align: left;
            width: 100%;
            max-width: 500px;
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border: 1px solid #ffeeba;
            border-radius: 6px;
            font-size: 14px;
            color: #856404;
        }

        .counter {
            font-weight: bold;
            font-size: 18px;
            color: #4b5563;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Label Layout Test</h1>

        <div class="controls">
            <div class="dimension-controls">
                <div class="control-group">
                    <label for="width">Label Width (in)</label>
                    <input type="number" id="width" value="2.25" step="0.05" style="padding: 5px; width: 80px;">
                </div>
                <div class="control-group">
                    <label for="height">Label Height (in)</label>
                    <input type="number" id="height" value="0.75" step="0.05" style="padding: 5px; width: 80px;">
                </div>
                <div class="control-group">
                    <label for="marginTop">Top Margin (in)</label>
                    <input type="number" id="marginTop" value="0.125" step="0.01" style="padding: 5px; width: 80px;">
                </div>
                <div class="control-group">
                    <label for="marginBottom">Bottom Margin (in)</label>
                    <input type="number" id="marginBottom" value="0.05" step="0.01" style="padding: 5px; width: 80px;">
                </div>
                <button onclick="renderCurrent()">Update Preview</button>
            </div>

            <div class="nav-controls">
                <button onclick="prevLabel()" id="prevBtn">← Previous</button>
                <span class="counter" id="counter">1 / 50</span>
                <button onclick="nextLabel()" id="nextBtn">Next →</button>
            </div>
        </div>

        <div id="output"></div>
    </div>

    <script>
        // --- DATA ---
        const testCases = [
            {
                "uid": "LONG-NAME-TEST",
                "room_name": "Master Bedroom",
                "drop_name": "Master Bedroom North Wall Speaker Left Channel",
                "wire_type": "16/2",
                "drop_type": "Speaker"
            },
            {
                "uid": "PATIOA-S-9557",
                "room_name": "Patio and Outside",
                "drop_name": "Patio and Outside Speaker 9",
                "wire_type": "16/2",
                "drop_type": "Speaker"
            },
            {
                "uid": "LIVING-IP-3284",
                "room_name": "Living Room",
                "drop_name": "IP",
                "wire_type": "Cat 6e",
                "drop_type": "IP/Data"
            },
            {
                "uid": "LIVING-L-8871",
                "room_name": "Living Room",
                "drop_name": "Living Room Lutron 3",
                "wire_type": "Lutron Red",
                "drop_type": "Lutron"
            },
            {
                "uid": "GAMERO-AP-6479",
                "room_name": "Game Room",
                "drop_name": "AP",
                "wire_type": "Cat 6e",
                "drop_type": "Access Point"
            }
        ];

        let currentIndex = 0;

        // --- RENDER LOGIC ---

        const generateWireDropLabelBitmap = async (wireDrop) => {
            // --- TEMPORARY CALIBRATION LOGIC START ---
            // Brady M211 printer resolution: 203 DPI
            const DPI = 203;

            // Dimensions
            const LABEL_WIDTH_INCHES = 1.5;
            const LABEL_HEIGHT_INCHES = 0.75;

            // Convert to pixels
            const WIDTH = Math.floor(LABEL_WIDTH_INCHES * DPI);
            const HEIGHT = Math.floor(LABEL_HEIGHT_INCHES * DPI);

            // Create canvas
            const canvas = document.createElement('canvas');
            canvas.width = WIDTH;
            canvas.height = HEIGHT;
            const ctx = canvas.getContext('2d');

            // 1. Background
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, WIDTH, HEIGHT);

            // 2. Settings for Ruler
            const CENTER_X = WIDTH / 2;
            const CENTER_Y = HEIGHT / 2;

            ctx.fillStyle = '#000000';
            ctx.strokeStyle = '#000000';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'top';

            // Draw Horizontal Line (X-Axis) across the middle
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(0, CENTER_Y);
            ctx.lineTo(WIDTH, CENTER_Y);
            ctx.stroke();

            // Draw Top/Bottom border lines to clearly see vertical cutoff
            ctx.lineWidth = 4;
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(WIDTH, 0); // Top edge
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(0, HEIGHT);
            ctx.lineTo(WIDTH, HEIGHT); // Bottom edge
            ctx.stroke();

            // Draw Vertical Center Line
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(CENTER_X, 0);
            ctx.lineTo(CENTER_X, HEIGHT);
            ctx.stroke();

            // --- DRAW TICKS ---
            const STEP_INCHES = 0.05;
            const STEP_PX = STEP_INCHES * DPI;

            // Function to draw tick
            const drawTick = (x, labelValue, isMajor) => {
                const tickHeight = isMajor ? (HEIGHT * 0.6) : (HEIGHT * 0.3); // Major ticks are taller
                const topY = (HEIGHT - tickHeight) / 2;
                const bottomY = topY + tickHeight;

                ctx.lineWidth = isMajor ? 2 : 1;
                ctx.beginPath();
                ctx.moveTo(x, topY);
                ctx.lineTo(x, bottomY);
                ctx.stroke();

                // Draw Label for Major Ticks (every 0.1")
                if (isMajor) {
                    ctx.font = 'bold 16px Arial';
                    // Label above the line
                    ctx.fillText(labelValue.toFixed(1), x, topY - 18);
                    // Label below the line
                    ctx.fillText(labelValue.toFixed(1), x, bottomY + 4);
                }
            };

            // 1. Go Right from Center
            let dist = 0;
            for (let x = CENTER_X; x <= WIDTH; x += STEP_PX) {
                const isMajor = Math.abs(dist % 0.1) < 0.001 || Math.abs(dist % 0.1) > 0.099;
                drawTick(x, dist, isMajor);
                dist += 0.05;
            }

            // 2. Go Left from Center
            dist = 0;
            for (let x = CENTER_X; x >= 0; x -= STEP_PX) {
                if (x !== CENTER_X) {
                    const isMajor = Math.abs(dist % 0.1) < 0.001 || Math.abs(dist % 0.1) > 0.099;
                    drawTick(x, dist, isMajor);
                }
                dist += 0.05;
            }

            // --- DRAW "SAFE ZONE" MARKERS (Visual Reference Only) ---
            const LIMIT_PX = 0.75 * DPI;
            const leftSafe = CENTER_X - LIMIT_PX;
            const rightSafe = CENTER_X + LIMIT_PX;

            ctx.strokeStyle = 'red';
            ctx.lineWidth = 1;

            ctx.beginPath(); ctx.moveTo(leftSafe, 0); ctx.lineTo(leftSafe, HEIGHT); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(rightSafe, 0); ctx.lineTo(rightSafe, HEIGHT); ctx.stroke();

            // Safe Zone Labels
            ctx.fillStyle = 'red';
            ctx.font = '10px Arial';
            ctx.fillText("OLD (0.75)", leftSafe, HEIGHT - 14);
            ctx.fillText("OLD (0.75)", rightSafe, HEIGHT - 14);

            // --- RETURN DATA ---
            return {
                dataUrl: canvas.toDataURL(),
                width: WIDTH,
                height: HEIGHT,
                marginTop: 0, // Not relevant for ruler
                marginBottom: 0,
                measurements: {
                    qrLeft: "0", qrRight: "0", textLeft: "0", textRight: "0" // Dummy values
                }
            };
            // --- TEMPORARY CALIBRATION LOGIC END ---
        };

        const loadImage = (dataUrl) => {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => resolve(img);
                img.onerror = reject;
                img.src = dataUrl;
            });
        };

        const wrapText = (ctx, text, maxWidth) => {
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';

            words.forEach(word => {
                const testLine = currentLine + (currentLine ? ' ' : '') + word;
                const metrics = ctx.measureText(testLine);

                if (metrics.width > maxWidth && currentLine) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = testLine;
                }
            });

            if (currentLine) {
                lines.push(currentLine);
            }

            return lines;
        };

        // --- UI LOGIC ---

        async function renderCurrent() {
            const output = document.getElementById('output');
            const data = testCases[currentIndex];
            const counter = document.getElementById('counter');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            output.innerHTML = '<div class="card">Generating...</div>';

            try {
                const result = await generateWireDropLabelBitmap(data);

                output.innerHTML = `
                    <div class="card">
                        <div class="label-preview-container">
                            <img src="${result.dataUrl}" alt="Label" class="label-preview">
                            <div class="guide-overlay">
                                <div class="guide-line" style="top: ${result.marginTop}px;">
                                    <span class="guide-label" style="top: -15px;">Top Margin</span>
                                </div>
                                <div class="guide-line" style="bottom: ${result.marginBottom}px; border-top: none; border-bottom: 1px dashed rgba(255,0,0,0.5);">
                                    <span class="guide-label" style="bottom: -15px;">Bottom Margin</span>
                                </div>
                            </div>
                        </div>
                        <div class="info">
                            <strong>Coordinates (Origin: Bottom Center):</strong><br>
                            QR Left X: <span style="color:red">${result.measurements.qrLeft}"</span><br>
                            QR Right X: <span style="color:red">${result.measurements.qrRight}"</span><br>
                            Text Left X: <span style="color:blue">${result.measurements.textLeft}"</span><br>
                            Text Right X: <span style="color:blue">${result.measurements.textRight}"</span><br>
                            <br>
                            <strong>Hardware Note:</strong> The Brady M211 has a fixed unprintable margin of ~0.4" on each side (left/right) for continuous labels. This "wasted" space is unavoidable due to the printer's cutter distance. We can only control the content within the label length.
                        </div>
                    </div>
                `;
            } catch (e) {
                output.innerHTML = `<div class="card" style="color:red">Error: ${e.message}</div>`;
                console.error(e);
            }

            counter.textContent = `${currentIndex + 1} / ${testCases.length}`;
            prevBtn.disabled = currentIndex === 0;
            nextBtn.disabled = currentIndex === testCases.length - 1;
        }

        function nextLabel() {
            if (currentIndex < testCases.length - 1) {
                currentIndex++;
                renderCurrent();
            }
        }

        function prevLabel() {
            if (currentIndex > 0) {
                currentIndex--;
                renderCurrent();
            }
        }

        window.onload = renderCurrent;
    </script>
</body>

</html>